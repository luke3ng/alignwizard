{% extends "basetwo.html" %}

{% block title %}Home{% endblock %}

{% block content %}
<h1 id="patientName"></h1>
<p id="patientInfo"></p>

<button id="usePatient" onclick="deleteImages()">Delete Images</button>

{% for object in data %}
<div class="container patient-data">
    <div class="image-grid">
        <div class="image-upload" id="front_{{ loop.index0 }}">
            <img id="front_img_{{ loop.index0 }}" />
        </div>
        <div class="image-upload" id="back_{{ loop.index0 }}">
            <img id="back_img_{{ loop.index0 }}" />
        </div>
        <div class="image-upload" id="left_{{ loop.index0 }}">
            <img id="left_img_{{ loop.index0 }}" />
        </div>
        <div class="image-upload" id="right_{{ loop.index0 }}">
            <img id="right_img_{{ loop.index0 }}" />
        </div>
    </div>
    <input type="checkbox" class="inp" id="id_{{ loop.index0 }}" value="{{ object.id }}">
    <label for="id_{{ loop.index0 }}"> {{ object.date }}</label><br>
</div>
{% endfor %}

<style>
    .image-upload {
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #ccc;
        margin: 10px;
        padding: 10px;
    }
    .image-upload img {
        max-width: 100%;
        max-height: 400px;
        object-fit: contain;
    }
</style>

<script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function() {
        const urlParams = new URLSearchParams(window.location.search);
        const patient = urlParams.get('data');

        if (patient) {
            document.getElementById('patientName').textContent = patient;
            document.getElementById('patientInfo').textContent = patient;
        }

        // Embed the data directly into the script
        const data = {{ data|tojson|safe }};
        console.log("Patient data:", data);

        // Process the data here
        // Loop through the data and set the content for each corresponding element
        data.forEach((item, index) => {
            const frontImg = document.getElementById(`front_img_${index}`);
            const backImg = document.getElementById(`back_img_${index}`);
            const leftImg = document.getElementById(`left_img_${index}`);
            const rightImg = document.getElementById(`right_img_${index}`);

            frontImg.src = 'data:image/jpeg;base64,' + item.frontImage;
            backImg.src = 'data:image/jpeg;base64,' + item.backImage;
            leftImg.src = 'data:image/jpeg;base64,' + item.leftImage;
            rightImg.src = 'data:image/jpeg;base64,' + item.rightImage;
        });

        $('input[type=checkbox]').on('change', function (e) {
            // No limit on number of checkboxes
        });
    });

    function deleteImages() {
        const dates = [...document.querySelectorAll('.inp:checked')].map(e => e.value);
        if (dates.length === 0) {
            alert("Please select at least one date.");
            return;
        }

        const patient = document.getElementById('patientName').textContent;

        // Send selected dates and patient info via fetch
        fetch('/removeImages', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ dates: dates })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Success:', data);
            // Optionally, reload the page or update the UI
            window.location.reload();
        })
        .catch((error) => {
            console.error('Error:', error);
        });
    }
</script>
{% endblock %}

